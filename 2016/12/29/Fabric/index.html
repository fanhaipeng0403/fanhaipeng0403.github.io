<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Fabric | 好记性不如烂笔头</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Fabric</h1><a id="logo" href="/.">好记性不如烂笔头</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Fabric</h1><div class="post-meta">Dec 29, 2016</div><div class="post-content"><p><a href="http://fabric-chs.readthedocs.io/zh_CN/chs/tutorial.html" target="_blank" rel="noopener">Fabric</a>是一个 Python (2.5-2.7) 的库和命令行工具，用来提高基于 SSH 的应用部署和系统管理效率。利用Fabric部署Python、Ruby、PHP这样的非编译型网站应用非常方便，而对于编译型的Java、C#等就麻烦了，编译本身就是一个极其复杂的大工程，需要依赖特定工具或者IDE，很难做到自动化。<br><a href="http://fabric-docs-cn.readthedocs.io/zh_CN/latest/" target="_blank" rel="noopener">http://fabric-docs-cn.readthedocs.io/zh_CN/latest/</a><br><a href="http://fabric-chs.readthedocs.io/zh_CN/chs/running_tests.html" target="_blank" rel="noopener">安装</a></p>
<h3 id="Fabric的基本操作命令"><a href="#Fabric的基本操作命令" class="headerlink" title="Fabric的基本操作命令"></a>Fabric的基本操作命令</h3><p>Fabric支持的常用命令列出如下：</p>
<ol>
<li>local<br>Run a command on the local system.<br>它是对subprocess模块的封装（Shell=True）可以通过设置Capture = True/False来捕获其执行结果。</li>
<li>run<br>Run a shell command on a remote host.<br>该命令的返回值包含了远程命令是否执行成功以及远程命令的返回码等信息。通过run执行命令时，通常会要求输入目标机器密码，如果对多台机器进行部署，可以通过设置env.passwords来避免手动输入密码，具体的设置方法会在下篇笔记中介绍。</li>
<li>get<br>Download one or more files from a remote host.</li>
<li>put<br>Upload one or more files to a remote host.</li>
<li>sudo<br>Run a shell command on a remote host, with superuser privileges.<br>功能与run操作类似，它可以对当前用户临时提权来执行某些需要root权限的命令。<br>此外，还有些不常用的命令（如：prompt, reboot, open_shell, require）这里没有列出</li>
</ol>
<a id="more"></a>
<h3 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h3><p>在fabric中，一组具有逻辑关系的操作通常被封装成一个task，fabric以task为粒度来执行命令，下面开始介绍如何定义task</p>
<h4 id="脚本名称与位置"><a href="#脚本名称与位置" class="headerlink" title="脚本名称与位置"></a>脚本名称与位置</h4><ul>
<li>基于fabric的部署脚本通常以fabfile.py命名且应该位于当期工作目录下以便于fab进行搜索，在该文件中实现我们想要的任务即可。当然，如果要实现的部署任务比较复杂，这些任务也可以写在多个脚本中，统一置于fabric package下。放置位置在根目录：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">|-- __init__.py</span><br><span class="line">|-- app.wsgi</span><br><span class="line">|-- fabfile.py &lt;-- our fabfile!</span><br><span class="line">|-- manage.py</span><br><span class="line">`-- my_app</span><br><span class="line">    |-- __init__.py</span><br><span class="line">    |-- models.py</span><br><span class="line">    |-- templates</span><br><span class="line">    |   `-- index.html</span><br><span class="line">    |-- tests.py</span><br><span class="line">    |-- urls.py</span><br><span class="line">    `-- views.py</span><br></pre></td></tr></table></figure>
<p>若不以fabfile.py命名,在创建它后输入 fab -f fab_tasks.py <task name=""> ，或者在 ~/.fabricrc 中添加 fabfile = fab_tasks.py 。</task></p>
<h4 id="定义task"><a href="#定义task" class="headerlink" title="定义task"></a>定义task</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@taskdef deploy(environment, domain=&quot;whatever.com&quot;):</span><br><span class="line">    run(&quot;git clone foo&quot;)</span><br><span class="line">    sudo(&quot;service apache2 restart&quot;)</span><br></pre></td></tr></table></figure>
<h4 id="为task指定目标机器"><a href="#为task指定目标机器" class="headerlink" title="为task指定目标机器"></a>为task指定目标机器</h4><p><strong>env.hosts</strong>和<strong>env.roles</strong>可以用来全局指定task的目标机器列表，这两个“环境变量”的默认值都是空列表[]。</p>
<h5 id="env-hosts"><a href="#env-hosts" class="headerlink" title="env.hosts"></a>env.hosts</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">env.hosts = [&apos;host1&apos;, &apos;host2&apos;]</span><br><span class="line">def taskA():</span><br><span class="line">    run(&apos;ls&apos;)</span><br><span class="line">def taskB():</span><br><span class="line">    run(&apos;whoami&apos;)</span><br></pre></td></tr></table></figure>
<h5 id="env-roles"><a href="#env-roles" class="headerlink" title="env.roles"></a>env.roles</h5><p>env.roles则是在配置了env.roledefs的情况下才有用武之地。在很多时候，不同的机器有着不同的角色，如有些是接入层，有些是业务层，有些是数据存储层。env.roledefs可以用来组织这些机器列表以体现其角色，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from fabric.api import env</span><br><span class="line"></span><br><span class="line">env.roledefs = &#123;    &apos;web&apos;: &#123;</span><br><span class="line">                 &apos;hosts&apos;: [&apos;www1&apos;, &apos;www2&apos;, &apos;www3&apos;],</span><br><span class="line">    &#125;,           &apos;db&apos;: &#123;</span><br><span class="line">                 &apos;hosts&apos;: [&apos;db1&apos;, &apos;db2&apos;],</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@roles(&apos;web&apos;)</span><br><span class="line">def mytask():</span><br><span class="line">    run(&apos;ls /var/www&apos;)</span><br></pre></td></tr></table></figure>
<p>上例通过env.roledefs配置了两个角色web和db，分别包含3台、2台机器，并借助@roles为mytask指定了目标机器列表。</p>
<h5 id="在命令行指定"><a href="#在命令行指定" class="headerlink" title="在命令行指定"></a>在命令行指定</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fab -H host1,host2 mytask1</span><br></pre></td></tr></table></figure>
<p>但这样操作，mytask只会在host1, host2上执行</p>
<p>如若</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">env.hosts.extend([&apos;host3&apos;, &apos;host4&apos;])</span><br><span class="line">def mytask():</span><br><span class="line">    run(&apos;ls /var/www&apos;)123456</span><br></pre></td></tr></table></figure>
<p>此时，当我们运行”fab -H host1,host2 mytask”时，env.hosts包含来自命令行和fabfile的4台机器。</p>
<h5 id="为每个任务指定host"><a href="#为每个任务指定host" class="headerlink" title="为每个任务指定host"></a>为每个任务指定host</h5><p>借助装饰器@hosts为每个任务指定目标机器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from fabric.api import env, run</span><br><span class="line"></span><br><span class="line">env.hosts.extend([&apos;host3&apos;, &apos;host4&apos;])</span><br><span class="line">def mytask():</span><br><span class="line">    run(&apos;ls /var/www&apos;）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   ##or#</span><br><span class="line">my_hosts = (&apos;host1&apos;, &apos;host2&apos;)</span><br><span class="line">@hosts(my_hosts)</span><br><span class="line">def mytask():</span><br><span class="line">    # ...</span><br></pre></td></tr></table></figure>
<h3 id="目标机器的密码管理"><a href="#目标机器的密码管理" class="headerlink" title="目标机器的密码管理"></a>目标机器的密码管理</h3><p>如果不想每次都输入SSH密码，需要事先在目标机器上生成ssh public key并配置在~/.ssh/config文件中，然后在定义任务的fabfile中将env.use_ssh_config设置为True,<br>来启用基于ssh public key方式的身份认证</p>
<p>可以参考这篇文章,<a href="http://www.ruanyifeng.com/blog/2011/12/ssh_remote_login.html" target="_blank" rel="noopener">SSH参考</a></p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><a href="http://fabric-chs.readthedocs.io/zh_CN/chs/api/core/colors.html" target="_blank" rel="noopener">彩色输出</a><br>运行”fab –list”来查看fabric可以识别的任务<br><a href="http://www.liaoxuefeng.com/article/001373892650475818672edc83c4c978a45195eab8dc753000" target="_blank" rel="noopener">http://www.liaoxuefeng.com/article/001373892650475818672edc83c4c978a45195eab8dc753000</a></p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li>开发 Fabric 时，最好建立一个独立的 virtualenv 环境来安装依赖并运行测试。</li>
<li>建议使用</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from fabric.api import *</span><br></pre></td></tr></table></figure>
<p>导入API,虽然不符合最佳规范，但是fabric本身也没多少API,不会和本地命名空间产生冲突，所以这样更为实用。</p>
<ol start="3">
<li>对于run命令注意</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run(&apos;cd /home/work/tmp&apos;)</span><br><span class="line">run(&apos;mkdir test&apos;)</span><br></pre></td></tr></table></figure>
<p>第2次run会重新创建ssh连接，且不会记忆上次cd到的目录</p>
<p>需要用下面的命令来实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run(&apos;cd /home/work/tmp; mkdir test&apos;)</span><br><span class="line">run(&apos;cd /home/work/tmp &amp;&amp; mkdir test&apos;)</span><br></pre></td></tr></table></figure>
<p>但建议更好的方式:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">with cd(&apos;/home/work/tmp&apos;):</span><br><span class="line">    run(&apos;mkdir test&apos;)</span><br></pre></td></tr></table></figure>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line">#-*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from datetime import datetime</span><br><span class="line">from fabric.api import *</span><br><span class="line"></span><br><span class="line">#登录用户和主机名：</span><br><span class="line">env.user = &apos;root&apos;</span><br><span class="line">env.hosts = [&apos;www.example.com&apos;] # 如果有多个主机，fabric会自动依次部署</span><br><span class="line"></span><br><span class="line">def pack():</span><br><span class="line">    &apos; 定义一个pack任务 &apos;</span><br><span class="line">    # 打一个tar包：</span><br><span class="line">    tar_files = [&apos;*.py&apos;, &apos;static/*&apos;, &apos;templates/*&apos;, &apos;favicon.ico&apos;]</span><br><span class="line">    local(&apos;rm -f example.tar.gz&apos;)</span><br><span class="line">    local(&apos;tar -czvf example.tar.gz --exclude=\&apos;*.tar.gz\&apos; --exclude=\&apos;fabfile.py\&apos; %s&apos; % &apos; &apos;.join(tar_files))</span><br><span class="line"></span><br><span class="line">def deploy():</span><br><span class="line">    &apos; 定义一个部署任务 &apos;</span><br><span class="line">    # 远程服务器的临时文件：</span><br><span class="line">    remote_tmp_tar = &apos;/tmp/example.tar.gz&apos;</span><br><span class="line">    tag = datetime.now().strftime(&apos;%y.%m.%d_%H.%M.%S&apos;)</span><br><span class="line">    run(&apos;rm -f %s&apos; % remote_tmp_tar)</span><br><span class="line">    # 上传tar文件至远程服务器：</span><br><span class="line">    put(&apos;shici.tar.gz&apos;, remote_tmp_tar)</span><br><span class="line">    # 解压：</span><br><span class="line">    remote_dist_dir = &apos;/srv/www.example.com@%s&apos; % tag</span><br><span class="line">    remote_dist_link = &apos;/srv/www.example.com&apos;</span><br><span class="line">    run(&apos;mkdir %s&apos; % remote_dist_dir)</span><br><span class="line">    with cd(remote_dist_dir):</span><br><span class="line">        run(&apos;tar -xzvf %s&apos; % remote_tmp_tar)</span><br><span class="line">    # 设定新目录的www-data权限:</span><br><span class="line">    run(&apos;chown -R www-data:www-data %s&apos; % remote_dist_dir)</span><br><span class="line">    # 删除旧的软链接：</span><br><span class="line">    run(&apos;rm -f %s&apos; % remote_dist_link)</span><br><span class="line">    # 创建新的软链接指向新部署的目录：</span><br><span class="line">    run(&apos;ln -s %s %s&apos; % (remote_dist_dir, remote_dist_link))</span><br><span class="line">    run(&apos;chown -R www-data:www-data %s&apos; % remote_dist_link)</span><br><span class="line">    # 重启fastcgi：</span><br><span class="line">    fcgi = &apos;/etc/init.d/py-fastcgi&apos;</span><br><span class="line">    with settings(warn_only=True):</span><br><span class="line">        run(&apos;%s stop&apos; % fcgi)</span><br><span class="line">    run(&apos;%s start&apos; % fcgi)</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">from __future__ import with_statement</span><br><span class="line">from fabric.api import *</span><br><span class="line">from fabric.contrib.console import confirm</span><br><span class="line"></span><br><span class="line">env.hosts = [&apos;my_server&apos;]</span><br><span class="line"></span><br><span class="line">def test():</span><br><span class="line">    with settings(warn_only=True):</span><br><span class="line">        result = local(&apos;./manage.py test my_app&apos;, capture=True)</span><br><span class="line">    if result.failed and not confirm(&quot;Tests failed. Continue anyway?&quot;):  # 这有个短逻辑</span><br><span class="line">      </span><br><span class="line">        abort(&quot;Aborting at user request.&quot;)</span><br><span class="line"></span><br><span class="line">def commit():</span><br><span class="line">    local(&quot;git add -p &amp;&amp; git commit&quot;)</span><br><span class="line"></span><br><span class="line">def push():</span><br><span class="line">    local(&quot;git push&quot;)</span><br><span class="line"></span><br><span class="line">def prepare_deploy():</span><br><span class="line">    test()</span><br><span class="line">    commit()</span><br><span class="line">    push()</span><br><span class="line"></span><br><span class="line">def deploy():</span><br><span class="line">    code_dir = &apos;/srv/django/myproject&apos;</span><br><span class="line">    with settings(warn_only=True):</span><br><span class="line">        if run(&quot;test -d %s&quot; % code_dir).failed:</span><br><span class="line">            run(&quot;git clone user@vcshost:/path/to/repo/.git %s&quot; % code_dir)</span><br><span class="line">    with cd(code_dir):</span><br><span class="line">        run(&quot;git pull&quot;)</span><br><span class="line">        run(&quot;touch app.wsgi&quot;)</span><br></pre></td></tr></table></figure>
<p>先看个例子，下面是一段部署脚本</p>
<h1 id="deploy-py"><a href="#deploy-py" class="headerlink" title="deploy.py"></a>deploy.py</h1><h1 id="1-创建一个远程连接"><a href="#1-创建一个远程连接" class="headerlink" title="1.  创建一个远程连接"></a>1.  创建一个远程连接</h1><h1 id="2-进入指定目录"><a href="#2-进入指定目录" class="headerlink" title="2. 进入指定目录"></a>2. 进入指定目录</h1><h1 id="3-在指定目录下面执行重启命令"><a href="#3-在指定目录下面执行重启命令" class="headerlink" title="3. 在指定目录下面执行重启命令"></a>3. 在指定目录下面执行重启命令</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fabric <span class="keyword">import</span> Connection</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># ip 我是随便填的</span></span><br><span class="line">    <span class="comment"># 如果你的电脑配了ssh免密码登录，就不需要 connect_kwargs 来指定密码了。</span></span><br><span class="line">    c = Connection(<span class="string">"root@232.231.231.22"</span>, connect_kwargs=&#123;<span class="string">"password"</span>: <span class="string">"youpassword"</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> c.cd(<span class="string">'/var/www/youproject'</span>):</span><br><span class="line">        c.run(<span class="string">"git pull origin master"</span>)</span><br><span class="line">        c.run(<span class="string">"/usr/bin/supervisorctl -c ../supervisor/supervisord.conf restart youproject"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>执行</p>
<p>python deploy.py<br>执行完成后，最新代码就已经部署到正式环境并重启了服务，是不是非常方便，妈妈再也不要担心我在正式环境敲错命令删数据库跑路了。</p>
<p>Fabric 不仅支持 Linux，而且在 Windows 平台也能很好的运行，在中小型项目，它是非常不错的运维工具，有了 Frabic ，管理上百台服务器都不成问题。</p>
<p>构建连接</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span><span class="params">(Context)</span>:</span></span><br><span class="line">    host = <span class="keyword">None</span></span><br><span class="line">    user = <span class="keyword">None</span></span><br><span class="line">    port = <span class="keyword">None</span></span><br><span class="line">    ssh_config = <span class="keyword">None</span></span><br><span class="line">    connect_timeout = <span class="keyword">None</span></span><br><span class="line">    connect_kwargs = <span class="keyword">None</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>构建 Connection 对象的方式有不同的方式，例如你可以将 host 写成 “<a href="mailto:root@192.168.101.1" target="_blank" rel="noopener">root@192.168.101.1</a>:22” ，也可以作为3个参数分开写。而 connect_kwargs 是字典对象，通常填服务器的登录密码或者密钥。</p>
<p>上传文件</p>
<p>run 方法用于执行命令，cd 进入指定目录，put 方法用于上传文件， 例如：</p>
<p>from fabric import Connection<br>c = Connection(‘web1’)<br>c.put(‘myfiles.tgz’, ‘/opt/mydata’)<br>c.run(‘tar -C /opt/mydata -xzvf /opt/mydata/myfiles.tgz’)<br>多台服务器</p>
<p>如果是要在多台服务器运行命令，简单的办法就是使用迭代，挨个服务器执行命令：</p>
<h1 id="web1-web2-mac1-都是服务器的名字，你也可以用ip代替"><a href="#web1-web2-mac1-都是服务器的名字，你也可以用ip代替" class="headerlink" title="web1,web2,mac1 都是服务器的名字，你也可以用ip代替"></a>web1,web2,mac1 都是服务器的名字，你也可以用ip代替</h1> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> fabric <span class="keyword">import</span> Connection</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> host <span class="keyword">in</span> (<span class="string">'web1'</span>, <span class="string">'web2'</span>, <span class="string">'mac1'</span>):</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>    result = Connection(host).run(<span class="string">'uname -s'</span>)</span><br><span class="line"><span class="meta">... </span>    print(<span class="string">"&#123;&#125;: &#123;&#125;"</span>.format(host, result.stdout.strip()))</span><br><span class="line">...</span><br><span class="line">web1: Linux</span><br><span class="line">web2: Linux</span><br><span class="line">mac1: Darwin</span><br><span class="line">或者使用 SerialGroup</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fabric <span class="keyword">import</span> SerialGroup <span class="keyword">as</span> Group</span><br><span class="line">pool = Group(<span class="string">'web1'</span>, <span class="string">'web2'</span>, <span class="string">'web3'</span>, connect_kwargs=&#123;<span class="string">"password"</span>: <span class="string">"youpassword"</span>&#125; )</span><br><span class="line">pool.put(<span class="string">'myfiles.tgz'</span>, <span class="string">'/opt/mydata'</span>)</span><br><span class="line">pool.run(<span class="string">'tar -C /opt/mydata -xzvf /opt/mydata/myfiles.tgz'</span>)</span><br><span class="line">Group(*hosts, **kwargs) 参数说明：</span><br></pre></td></tr></table></figure>
<p>*hosts: 可以传入多个主机名或IP<br>**kwargs 接收的参数可以和Connection一样，可以指定密码</p>
</div><div class="tags"><a href="/tags/Deploy/">Deploy</a></div><div class="post-nav"><a class="pre" href="/2016/12/29/tar命令/">tar命令</a><a class="next" href="/2016/12/29/自动部署/">自动部署</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://iusepython.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/FrontEnd/">FrontEnd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Others/">Others</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spider/">Spider</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/sqlalchemy/" style="font-size: 15px;">sqlalchemy</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/FrontEnd/" style="font-size: 15px;">FrontEnd</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/Deploy/" style="font-size: 15px;">Deploy</a> <a href="/tags/ELK/" style="font-size: 15px;">ELK</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Mysql/" style="font-size: 15px;">Mysql</a> <a href="/tags/IDE/" style="font-size: 15px;">IDE</a> <a href="/tags/Database/" style="font-size: 15px;">Database</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/Virtualenv/" style="font-size: 15px;">Virtualenv</a> <a href="/tags/Ubuntu/" style="font-size: 15px;">Ubuntu</a> <a href="/tags/Html/" style="font-size: 15px;">Html</a> <a href="/tags/Flask/" style="font-size: 15px;">Flask</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/Shell/" style="font-size: 15px;">Shell</a> <a href="/tags/Spider/" style="font-size: 15px;">Spider</a> <a href="/tags/Vim/" style="font-size: 15px;">Vim</a> <a href="/tags/Webpack/" style="font-size: 15px;">Webpack</a> <a href="/tags/zsh/" style="font-size: 15px;">zsh</a> <a href="/tags/Others/" style="font-size: 15px;">Others</a> <a href="/tags/DA/" style="font-size: 15px;">DA</a> <a href="/tags/Socket/" style="font-size: 15px;">Socket</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/01/26/snippet/">async awit</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/11/celery for prometheus/">celery for prometheus monitoring</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/30/class属性缓存/">缓存property</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/17/ELK/">ELK stack</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/12/Sqlalchemy 的级联删除配置/">Sqlalchemy 的级联删除配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/12/磁盘查看/">磁盘</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/12/proc目录/">proc目录</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/12/参数装饰器/">参数装饰器</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/11/进程的通信方式/">进程的通信方式</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/04/日志搜索/">日志搜索</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://github.com/fanhaipeng0403" title="Github" target="_blank">Github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">好记性不如烂笔头.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>