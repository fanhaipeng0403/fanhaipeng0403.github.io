<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>进程的通信方式 | 好记性不如烂笔头</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">进程的通信方式</h1><a id="logo" href="/.">好记性不如烂笔头</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">进程的通信方式</h1><div class="post-meta">Dec 11, 2018<span> | </span><span class="category"><a href="/categories/Linux/">Linux</a></span></div><div class="post-content"><p>Python的进程间通信<br>进程间通讯有多种方式，包括信号，管道，消息队列，信号量，共享内存，socket等</p>
<p>#共享内存</p>
<p>Python可以通过mmap模块实现进程之间的共享内存</p>
<p>mmap文件对象既像一个字符串也像一个普通文件对象。像字符串时因为我们可以改变其中的单个字符，如，obj[index] = ‘a’，同时我们也可以改变一小段的字符，如 obj[2:5]=’aaa’。像文件对象是因为在mmap中会有操作标记，我们可以使用seek()方法来改变mmap对象的操作标记<br>mmap对象通过mmap()方法来构建，Windows系统和Unix系统下，构建方法是不同的。<br>window的构造方法：<br>class mmap.mmap(fileno, length[, tagname[, access[, offset]]])<br>linux的构造方法：<br>class mmap.mmap(fileno, length[, flags[, prot[, access[, offset]]]])</p>
<p>fileno是文件的标号，可以是普通的文件对象的标号，（文件对象通过fileno()方法获得），也可以是-1，-1代表这个内存是无名的。length参数定义该内存的长度，如果为0，就去fileno对应的文件的最大长度，access是改mmap对象的权限，可以是ACCESS_READ,ACCESS_WRITE ,ACCESS_COPY三个值，<br>。<br>linux中，<br>flags的值可以是MAP_PRIVATE 和MAP_SHARED ，默认是MAP_SHARED ，改参数用来标识改内存是私有的还是共享的<br>prot的值可以是PROT_READ 和PROT_WRITE，也是用来定义该mmap的权限的<br>flags+ prot 和access这种权限定义方式只能取一种，否则会报错<br>window中<br>tagname是这个mmap的标记，用来唯一标记这一块共享内存，作用像fileno</p>
<p>由于有tagname这个参数，所以在windows中，可以通过领fileno为-1，然后自定义一个tagname，例如‘mysharename’,来令多个进程都能共享同一块内存<br>但是在linux中，这种方法就不可以用了，只能通过打开一个文件，获取fileno来实现。<br>所以在window中，共享内存更加灵活<br>mmap对象常用的方法：<br>mmap.close() 关闭对象<br>mmap.find(string[, start[, end]])   在共享内存中查找内容，返回匹配内容最小的操作标记<br>mmap.flush([offset, size])  把内存的数据保存到硬盘中<br>mmap.move(dest, src, count) 移动操作标记<br>mmap.read(num)  从操作标记开始读取num个长度的字符<br>mmap.read_byte()  读取二进制数据<br>mmap.readline()   读取一行数据<br>mmap.resize(newsize)  修改mmap的长度<br>mmap.rfind(string[, start[, end]])   在共享内存中查找内容，返回匹配内容最大的操作标记<br>mmap.seek(pos[, whence])  移动操作标记<br>mmap.size()  返回mmap对象的长度<br>mmap.tell()  返回当前操作标记的位置<br>mmap.write(string)  写入内容.<br>mmap.write_byte(byte)  写入二进制内容</p>
<p>linux构造例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">share_file=&apos;/tmp/mm.txt&apos;</span><br><span class="line">f = open(share_file, &apos;wb&apos;)</span><br><span class="line">f.write(&apos;a&apos; * share_size)</span><br><span class="line">f.close()</span><br><span class="line">f = open(share_file, &apos;r+b&apos;)</span><br><span class="line">mm = mmap.mmap(f.fileno(), 0)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<p>因为mmap对象的长度不能大于文件的长度，不然会报错：ValueError: mmap offset is greater than file siz</p>
<p>所以需要以wb的形式，先打开共享的文件，然后写入需要共享内存的长度的内容，关闭文件后以r+b方式打开文件，然后构造mmap对象。</p>
<p>当然，下次就可以直接用r+b的方式打开文件，然后构造对象了</p>
<p>参考：<a href="https://docs.python.org/2/library/mmap.html#module-mmap" target="_blank" rel="noopener">https://docs.python.org/2/library/mmap.html#module-mmap</a></p>
<h1 id="信号"><a href="#信号" class="headerlink" title="信号"></a>信号</h1><p>信号（signal）–     进程之间通讯的方式。一个进程一旦接收到信号就会打断原来的程序执行流程来处理信号。</p>
<p>几个常用信号:</p>
<p>SIGINT     终止进程  中断进程  (control+c)</p>
<p>SIGTERM   终止进程     软件终止信号</p>
<p>SIGKILL   终止进程     杀死进程</p>
<p>SIGALRM 闹钟信号</p>
<p>相对于共享内存，信号更加偏向于系统层面的，linux系统也是通过信号来管理进程，而且系统也规定了某些进程接到某些信号后的行为。</p>
<p>当然我们可以通过绑定信号处理函数来修改进程收到信号以后的行为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#encoding=utf-8</span><br><span class="line">import os</span><br><span class="line">import signal</span><br><span class="line">from time import sleep</span><br><span class="line">def my_term(a,b):</span><br><span class="line">    print &quot;收到sigterm信号&quot;</span><br><span class="line">signal.signal(signal.SIGTERM,my_term)</span><br><span class="line">def my_usr1(a,b):</span><br><span class="line">    print &quot;收到SIGUSR1信号&quot;</span><br><span class="line">signal.signal(signal.SIGUSR1,my_usr1)</span><br><span class="line">while 1:</span><br><span class="line">    print &quot;我是进程id是&quot;,os.getpid()</span><br><span class="line">    sleep(1)</span><br></pre></td></tr></table></figure>
<p>#通过Queue</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__author__ = &apos;lujianxing&apos;</span><br><span class="line">import threading</span><br><span class="line">from time import sleep</span><br><span class="line"></span><br><span class="line">def f(q,t):</span><br><span class="line">    q.put(t)</span><br><span class="line"></span><br><span class="line">from multiprocessing import Process,Queue</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    q=Queue()</span><br><span class="line">    p = Process(target=f, args=(q,&apos;ljx.sa&apos;))</span><br><span class="line">    p.start()</span><br><span class="line">    p.join()</span><br><span class="line">    p1 = Process(target=f, args=(q,&apos;ljx.elex&apos;))</span><br><span class="line">    p1.start()</span><br><span class="line">    p1.join()</span><br><span class="line">    print q.qsize()</span><br></pre></td></tr></table></figure>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2018/12/12/参数装饰器/">参数装饰器</a><a class="next" href="/2018/12/04/日志搜索/">日志搜索</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://iusepython.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/FrontEnd/">FrontEnd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Others/">Others</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spider/">Spider</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/sqlalchemy/" style="font-size: 15px;">sqlalchemy</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/FrontEnd/" style="font-size: 15px;">FrontEnd</a> <a href="/tags/ELK/" style="font-size: 15px;">ELK</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/Deploy/" style="font-size: 15px;">Deploy</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/IDE/" style="font-size: 15px;">IDE</a> <a href="/tags/Mysql/" style="font-size: 15px;">Mysql</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/Ubuntu/" style="font-size: 15px;">Ubuntu</a> <a href="/tags/Virtualenv/" style="font-size: 15px;">Virtualenv</a> <a href="/tags/Database/" style="font-size: 15px;">Database</a> <a href="/tags/Flask/" style="font-size: 15px;">Flask</a> <a href="/tags/Html/" style="font-size: 15px;">Html</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/Shell/" style="font-size: 15px;">Shell</a> <a href="/tags/Spider/" style="font-size: 15px;">Spider</a> <a href="/tags/Vim/" style="font-size: 15px;">Vim</a> <a href="/tags/Webpack/" style="font-size: 15px;">Webpack</a> <a href="/tags/zsh/" style="font-size: 15px;">zsh</a> <a href="/tags/Others/" style="font-size: 15px;">Others</a> <a href="/tags/DA/" style="font-size: 15px;">DA</a> <a href="/tags/Socket/" style="font-size: 15px;">Socket</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/01/26/snippet/">async awit</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/11/celery for prometheus/">celery for prometheus monitoring</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/30/class属性缓存/">缓存property</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/17/ELK/">ELK stack</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/12/proc目录/">proc目录</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/12/磁盘查看/">磁盘</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/12/Sqlalchemy 的级联删除配置/">Sqlalchemy 的级联删除配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/12/参数装饰器/">参数装饰器</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/11/进程的通信方式/">进程的通信方式</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/04/日志搜索/">日志搜索</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://github.com/fanhaipeng0403" title="Github" target="_blank">Github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">好记性不如烂笔头.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>